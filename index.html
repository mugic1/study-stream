<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyStream</title>
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- YouTube API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <style>
        /* --- CORE STYLES --- */
        :root {
            --primary: #4f46e5;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-sec: #64748b;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0f172a;
                --surface: #1e293b;
                --text-main: #f1f5f9;
                --text-sec: #94a3b8;
            }
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text-main); padding-bottom: 80px; }
        
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Navbar */
        .navbar {
            position: fixed; top: 0; left: 0; right: 0; height: 60px;
            background: var(--surface); border-bottom: 1px solid rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 100;
        }
        .logo { font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .btn-add {
            background: var(--primary); color: white; border: none; padding: 8px 16px; 
            border-radius: 20px; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; cursor: pointer;
        }

        /* Container */
        .container { max-width: 800px; margin: 80px auto 0; padding: 0 16px; }
        
        /* Dashboard */
        .dash-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 30px; }
        .dash-card {
            background: var(--surface); padding: 15px; border-radius: 12px;
            text-align: center; border: 1px solid rgba(0,0,0,0.1); cursor: pointer;
        }
        
        /* Video Card */
        .video-card {
            background: var(--surface); border-radius: 12px; margin-bottom: 16px;
            overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-direction: column;
        }
        .video-card.completed { opacity: 0.6; filter: grayscale(1); }
        .thumb-box {
            position: relative; width: 100%; aspect-ratio: 16/9; background: #000; cursor: pointer;
        }
        .thumb-img { width: 100%; height: 100%; object-fit: cover; }
        .play-icon {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9); width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: black;
        }
        .progress-bar { height: 4px; background: #ddd; width: 100%; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; }
        
        .card-meta { padding: 12px; display: flex; justify-content: space-between; align-items: center; }
        .v-info h3 { font-size: 0.9rem; margin-bottom: 4px; line-height: 1.3; }
        .v-cat { font-size: 0.7rem; text-transform: uppercase; color: var(--text-sec); font-weight: bold; }
        
        /* Player Overlay */
        .player-overlay {
            position: fixed; inset: 0; background: black; z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .player-controls {
            position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 1001;
        }
        .control-btn {
            color: white; background: rgba(255,255,255,0.2); backdrop-filter: blur(4px);
            border: none; width: 40px; height: 40px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .video-wrapper { width: 100%; max-width: 900px; aspect-ratio: 16/9; background: #000; position: relative; }
        iframe { width: 100%; height: 100%; border: none; }
        
        /* Modal */
        .modal-wrap {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 500;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .modal-box {
            background: var(--surface); width: 100%; max-width: 400px; padding: 20px; border-radius: 16px;
        }
        .input-area { width: 100%; height: 100px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin: 10px 0; background: var(--bg); color: var(--text-main);}
        
        /* Bottom Nav */
        .btm-nav {
            position: fixed; bottom: 0; left: 0; right: 0; height: 60px;
            background: var(--surface); border-top: 1px solid rgba(0,0,0,0.1);
            display: flex; justify-content: space-around; align-items: center;
        }
        .btm-btn { background: none; border: none; display: flex; flex-direction: column; align-items: center; font-size: 10px; color: var(--text-sec); gap: 4px; }
        .btm-btn.active { color: var(--primary); }

    </style>
</head>
<body>

<div id="app"></div>

<script>
    const app = {
        data: {
            tab: 'home',
            videos: [],
            modalOpen: false,
            addCat: 'physics',
            tempLinks: ''
        },

        init() {
            const saved = localStorage.getItem('studyStreamDB');
            if (saved) {
                try { app.data.videos = JSON.parse(saved); } catch(e){}
            }
            app.render();
        },

        save() {
            localStorage.setItem('studyStreamDB', JSON.stringify(app.data.videos));
            app.render();
        },

        // Actions
        setTab(t) { app.data.tab = t; app.render(); window.scrollTo(0,0); },
        toggleModal(v) { app.data.modalOpen = v; app.render(); },
        setCat(c) { app.data.addCat = c; app.render(); },

        addVideos() {
            const input = document.getElementById('linkBox').value;
            const matches = input.matchAll(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))([\w-]{11})/g);
            const ids = new Set([...matches].map(m => m[1]));

            if(ids.size > 0) {
                ids.forEach(id => {
                    if(!app.data.videos.find(v => v.id === id)) {
                        app.data.videos.push({
                            id, category: app.data.addCat, status: 'new',
                            progress: 0, duration: 0, added: Date.now(), lastWatched: 0
                        });
                    }
                });
                app.data.modalOpen = false;
                app.save();
            } else {
                alert("No valid YouTube links found!");
            }
        },

        deleteVideo(id) {
            if(confirm("Delete video?")) {
                app.data.videos = app.data.videos.filter(v => v.id !== id);
                app.save();
            }
        },

        // --- FULLSCREEN PLAYER LOGIC ---
        playVideo(id) {
            const video = app.data.videos.find(v => v.id === id);
            if(!video) return;

            const overlay = document.createElement('div');
            overlay.className = 'player-overlay fade-in';
            overlay.id = 'fs-container';
            overlay.innerHTML = `
                <div class="player-controls">
                    <button class="control-btn" onclick="app.toggleFullScreen()"><i data-lucide="maximize"></i></button>
                    <button class="control-btn" onclick="app.closePlayer()"><i data-lucide="x"></i></button>
                </div>
                <div class="video-wrapper">
                    <p style="color:white; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:0;">Loading...</p>
                    <iframe 
                        id="yt-iframe"
                        src="https://www.youtube.com/embed/${id}?enablejsapi=1&autoplay=1&fs=1&start=${Math.floor(video.progress)}&rel=0" 
                        allow="autoplay; encrypted-media; fullscreen"
                        allowfullscreen
                        style="position:relative; z-index:1;"
                    ></iframe>
                </div>
            `;
            document.body.appendChild(overlay);
            lucide.createIcons();

            if (window.YT && window.YT.Player) {
                new YT.Player('yt-iframe', {
                    events: {
                        'onStateChange': (e) => {
                            if (e.data === 0) app.markComplete(id);
                            if (e.data === 2) app.updateProgress(id, e.target.getCurrentTime(), e.target.getDuration());
                        }
                    }
                });
            }
        },

        toggleFullScreen() {
            const elem = document.getElementById('fs-container');
            if (!document.fullscreenElement) {
                if (elem.requestFullscreen) { elem.requestFullscreen(); } 
                else if (elem.webkitRequestFullscreen) { elem.webkitRequestFullscreen(); } 
                else if (elem.msRequestFullscreen) { elem.msRequestFullscreen(); }
            } else {
                if (document.exitFullscreen) { document.exitFullscreen(); }
            }
        },

        closePlayer() {
            // Exit fullscreen if active before closing
            if (document.fullscreenElement) {
                if (document.exitFullscreen) { document.exitFullscreen(); }
            }
            const ov = document.querySelector('.player-overlay');
            if(ov) ov.remove();
            app.render();
        },

        updateProgress(id, time, duration) {
            const idx = app.data.videos.findIndex(v => v.id === id);
            if(idx > -1) {
                app.data.videos[idx].status = 'in-progress';
                app.data.videos[idx].progress = time;
                app.data.videos[idx].duration = duration;
                app.data.videos[idx].lastWatched = Date.now();
                localStorage.setItem('studyStreamDB', JSON.stringify(app.data.videos));
            }
        },

        markComplete(id) {
            const idx = app.data.videos.findIndex(v => v.id === id);
            if(idx > -1) {
                app.data.videos[idx].status = 'completed';
                app.data.videos[idx].progress = app.data.videos[idx].duration;
                app.save();
                app.closePlayer();
            }
        },

        exportData() {
            const data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(app.data.videos));
            const a = document.createElement('a');
            a.href = data; a.download = 'study_backup.json';
            document.body.appendChild(a); a.click(); a.remove();
        },

        importData(el) {
            const reader = new FileReader();
            reader.onload = (e) => {
                app.data.videos = JSON.parse(e.target.result);
                app.save();
            };
            reader.readAsText(el.files[0]);
        },

        // --- RENDER UI ---
        render() {
            const isHome = app.data.tab === 'home';
            let list = app.data.videos;
            
            if(!isHome) {
                list = list.filter(v => v.category === app.data.tab);
            } else {
                list = list.filter(v => v.status === 'in-progress').sort((a,b) => b.lastWatched - a.lastWatched);
            }

            if(!isHome) {
                list.sort((a,b) => {
                    if (a.status === 'completed' && b.status !== 'completed') return 1;
                    if (a.status !== 'completed' && b.status === 'completed') return -1;
                    if (a.status === 'in-progress' && b.status === 'in-progress') return b.lastWatched - a.lastWatched;
                    if (a.status === 'in-progress') return -1;
                    if (b.status === 'in-progress') return 1;
                    return b.added - a.added;
                });
            }

            let html = `
                <nav class="navbar">
                    <div class="logo"><i data-lucide="book-open" width="20"></i> StudyStream</div>
                    <button class="btn-add" onclick="app.toggleModal(true)"><i data-lucide="plus" width="16"></i> Add</button>
                </nav>
                <div class="container fade-in">
            `;

            if(isHome) {
                html += `<h2 style="margin-bottom:15px">Dashboard</h2>`;
                html += `<div class="dash-grid">
                    ${['physics','chemistry','biology'].map(c => {
                        const count = app.data.videos.filter(v => v.category === c && v.status !== 'completed').length;
                        return `<div class="dash-card" onclick="app.setTab('${c}')">
                            <i data-lucide="${c==='physics'?'atom':c==='chemistry'?'flask-conical':'dna'}" style="margin-bottom:5px; color:var(--primary)"></i>
                            <h3>${c}</h3><small>${count} left</small>
                        </div>`;
                    }).join('')}
                </div>
                <h3>Continue Watching</h3>`;
                if(list.length === 0) html += `<p style="color:gray; padding:20px 0;">No videos in progress.</p>`;
            } else {
                html += `<h2 style="text-transform:capitalize; margin-bottom:15px">${app.data.tab}</h2>`;
            }

            html += list.map(v => {
                const pct = v.duration ? (v.progress/v.duration)*100 : 0;
                return `
                <div class="video-card ${v.status==='completed'?'completed':''}">
                    <div class="thumb-box" onclick="app.playVideo('${v.id}')">
                        <img class="thumb-img" src="https://img.youtube.com/vi/${v.id}/hqdefault.jpg">
                        <div class="play-icon"><i data-lucide="play" width="18" fill="black"></i></div>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${v.status==='completed'?100:pct}%"></div></div>
                    <div class="card-meta">
                        <div class="v-info">
                            <span class="v-cat">${v.category}</span>
                            <h3>Video ${v.id.substring(0,6)}...</h3>
                        </div>
                        <button onclick="event.stopPropagation(); app.deleteVideo('${v.id}')" style="background:none; border:none; color:#ef4444;"><i data-lucide="trash-2" width="16"></i></button>
                    </div>
                </div>`;
            }).join('');

            if(isHome) {
                 html += `<div style="margin-top:40px; border-top:1px solid #ddd; padding-top:20px; display:flex; justify-content:space-between">
                    <button onclick="app.exportData()" style="padding:10px; background:#eee; border:none; border-radius:8px;">Export Data</button>
                    <label style="padding:10px; background:#eee; border:none; border-radius:8px; cursor:pointer">Import <input type="file" hidden onchange="app.importData(this)"></label>
                 </div>`;
            }

            html += `</div>`;

            if(app.data.modalOpen) {
                html += `
                <div class="modal-wrap">
                    <div class="modal-box fade-in">
                        <h3>Add Videos</h3>
                        <div style="display:flex; gap:10px; margin:15px 0;">
                            ${['physics','chemistry','biology'].map(c => 
                                `<button onclick="app.setCat('${c}')" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:8px; background:${app.data.addCat===c?'#e0e7ff':'white'}; text-transform:capitalize">${c}</button>`
                            ).join('')}
                        </div>
                        <textarea id="linkBox" class="input-area" placeholder="Paste YouTube links here..."></textarea>
                        <div style="display:flex; gap:10px;">
                            <button onclick="app.addVideos()" style="flex:1; background:var(--primary); color:white; padding:10px; border:none; border-radius:8px;">Import</button>
                            <button onclick="app.toggleModal(false)" style="padding:10px; border:none; background:#eee; border-radius:8px;">Cancel</button>
                        </div>
                    </div>
                </div>`;
            }

            html += `
            <div class="btm-nav md:hidden">
                 ${['home','physics','chemistry','biology'].map(t => 
                     `<button class="btm-btn ${app.data.tab===t?'active':''}" onclick="app.setTab('${t}')">
                        <i data-lucide="${t==='home'?'home':t==='physics'?'atom':t==='chemistry'?'flask-conical':'dna'}" width="20"></i>
                        <span style="text-transform:capitalize">${t}</span>
                     </button>`
                 ).join('')}
            </div>`;

            document.getElementById('app').innerHTML = html;
            lucide.createIcons();
        }
    };

    window.onload = app.init;
</script>

</body>
  </html>
