<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyStream</title>
    
    <!-- PWA Metadata -->
    <meta name="theme-color" content="#4f46e5">
    <meta name="description" content="Track and organize your study videos">
    <meta name="keywords" content="study, videos, education, learning, youtube, organizer">
    <meta name="author" content="StudyStream">
    
    <!-- Apple PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="StudyStream">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    
    <!-- Windows PWA Support -->
    <meta name="msapplication-TileColor" content="#4f46e5">
    <meta name="msapplication-TileImage" content="/icons/icon-144x144.png">
    <meta name="msapplication-config" content="/browserconfig.xml">
    
    <!-- Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" href="/icons/icon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/icons/icon-16x16.png" sizes="16x16">
    
    <!-- Icons Library -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- YouTube API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <style>
        /* --- CORE STYLES --- */
        :root {
            --primary: #4f46e5;
            --primary-light: #818cf8;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-sec: #64748b;
            --border: #e2e8f0;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0f172a;
                --surface: #1e293b;
                --text-main: #f1f5f9;
                --text-sec: #94a3b8;
                --border: #334155;
            }
        }
        
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; 
            background: var(--bg); 
            color: var(--text-main); 
            padding-bottom: 80px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Navbar */
        .navbar {
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            height: 60px;
            background: var(--surface); 
            border-bottom: 1px solid var(--border);
            display: flex; 
            align-items: center; 
            padding: 0 16px; 
            z-index: 100;
            gap: 12px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .logo { 
            font-weight: bold; 
            color: var(--primary); 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 1.1rem; 
        }
        
        .search-box {
            flex: 1; 
            max-width: 400px; 
            position: relative;
        }
        
        .search-box input {
            width: 100%; 
            padding: 8px 12px 8px 36px; 
            border: 1px solid var(--border); 
            border-radius: 20px; 
            background: var(--bg); 
            color: var(--text-main);
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .search-box i { 
            position: absolute; 
            left: 12px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: var(--text-sec); 
        }
        
        .btn-add {
            background: var(--primary); 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 20px; 
            font-size: 0.9rem; 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            cursor: pointer;
            white-space: nowrap;
            transition: background-color 0.2s, transform 0.2s;
        }
        
        .btn-add:hover {
            background: var(--primary-light);
            transform: translateY(-1px);
        }

        /* Container */
        .container { 
            max-width: 800px; 
            margin: 80px auto 0; 
            padding: 0 16px; 
        }
        
        /* Stats Grid */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 10px; 
            margin: 20px 0; 
        }
        
        .stat-card {
            background: var(--surface); 
            padding: 15px; 
            border-radius: 12px;
            text-align: center; 
            border: 1px solid var(--border);
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .stat-card h3 { 
            font-size: 1.5rem; 
            margin: 8px 0; 
            color: var(--primary); 
        }
        
        .stat-card p { 
            font-size: 0.8rem; 
            color: var(--text-sec); 
        }
        
        /* Dashboard Grid */
        .dash-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 10px; 
            margin: 20px 0; 
        }
        
        .dash-card {
            background: var(--surface); 
            padding: 15px; 
            border-radius: 12px;
            text-align: center; 
            border: 1px solid var(--border); 
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .dash-card:hover { 
            transform: translateY(-2px); 
            border-color: var(--primary);
        }
        
        /* Video Card */
        .video-card {
            background: var(--surface); 
            border-radius: 12px; 
            margin-bottom: 16px;
            overflow: hidden; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); 
            display: flex; 
            flex-direction: column;
            transition: transform 0.2s;
        }
        
        .video-card:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.12); 
        }
        
        .video-card.completed { 
            opacity: 0.7; 
        }
        
        .thumb-box {
            position: relative; 
            width: 100%; 
            aspect-ratio: 16/9; 
            background: #000; 
            cursor: pointer;
        }
        
        .thumb-img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        
        .play-icon {
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95); 
            width: 48px; 
            height: 48px; 
            border-radius: 50%;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: var(--primary);
            opacity: 0; 
            transition: opacity 0.2s;
        }
        
        .thumb-box:hover .play-icon { 
            opacity: 1; 
        }
        
        .progress-bar { 
            height: 4px; 
            background: var(--border); 
            width: 100%; 
        }
        
        .progress-fill { 
            height: 100%; 
            background: var(--primary); 
            width: 0%; 
            transition: width 0.3s; 
        }
        
        .card-meta { 
            padding: 12px; 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
        }
        
        .v-info { 
            flex: 1; 
        }
        
        .v-info h3 { 
            font-size: 0.95rem; 
            margin-bottom: 4px; 
            line-height: 1.4; 
            display: -webkit-box; 
            -webkit-line-clamp: 2; 
            -webkit-box-orient: vertical; 
            overflow: hidden; 
        }
        
        .v-cat { 
            font-size: 0.7rem; 
            text-transform: uppercase; 
            color: var(--text-sec); 
            font-weight: bold;
            display: inline-block; 
            padding: 2px 8px; 
            background: var(--bg); 
            border-radius: 4px; 
            margin-bottom: 6px;
        }
        
        /* Status badges */
        .status-badge {
            font-size: 0.7rem; 
            padding: 2px 8px; 
            border-radius: 10px; 
            margin-left: 8px;
        }
        
        .status-new { 
            background: #fef3c7; 
            color: #92400e; 
        }
        
        .status-in-progress { 
            background: #dbeafe; 
            color: #1e40af; 
        }
        
        .status-completed { 
            background: #d1fae5; 
            color: #065f46; 
        }
        
        /* Player Overlay */
        .player-overlay {
            position: fixed; 
            inset: 0; 
            background: black; 
            z-index: 1000;
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center;
        }
        
        .player-controls {
            position: absolute; 
            top: env(safe-area-inset-top, 20px); 
            right: env(safe-area-inset-right, 20px); 
            display: flex; 
            gap: 10px; 
            z-index: 1001;
        }
        
        .control-btn {
            color: white; 
            background: rgba(255,255,255,0.2); 
            backdrop-filter: blur(4px);
            border: none; 
            width: 44px; 
            height: 44px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .control-btn:hover { 
            background: rgba(255,255,255,0.3); 
        }
        
        .video-wrapper { 
            width: 100%; 
            max-width: min(900px, 100vw); 
            aspect-ratio: 16/9; 
            background: #000; 
            position: relative; 
        }
        
        iframe { 
            width: 100%; 
            height: 100%; 
            border: none; 
        }
        
        /* Modal */
        .modal-wrap {
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.5); 
            z-index: 500;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 20px;
            backdrop-filter: blur(2px);
        }
        
        .modal-box {
            background: var(--surface); 
            width: 100%; 
            max-width: 500px; 
            border-radius: 16px;
            overflow: hidden; 
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            animation: modalSlide 0.3s ease;
        }
        
        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header { 
            padding: 20px; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .modal-body { 
            padding: 20px; 
        }
        
        .input-area { 
            width: 100%; 
            min-height: 120px; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            padding: 12px; 
            margin: 10px 0; 
            background: var(--bg); 
            color: var(--text-main);
            font-family: inherit; 
            resize: vertical;
            transition: border-color 0.2s;
        }
        
        .input-area:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        /* Category chips */
        .category-chips {
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            margin: 15px 0;
        }
        
        .category-chip {
            padding: 8px 16px; 
            border: 1px solid var(--border); 
            border-radius: 20px;
            background: var(--bg); 
            color: var(--text-main); 
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .category-chip:hover {
            border-color: var(--primary);
        }
        
        .category-chip.selected {
            background: var(--primary); 
            color: white; 
            border-color: var(--primary);
        }
        
        /* Button styles */
        .btn-primary {
            background: var(--primary); 
            color: white; 
            border: none; 
            padding: 12px 24px;
            border-radius: 8px; 
            font-size: 1rem; 
            cursor: pointer; 
            transition: background 0.2s;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px;
        }
        
        .btn-primary:hover { 
            background: var(--primary-light); 
        }
        
        .btn-secondary {
            background: var(--bg); 
            color: var(--text-main); 
            border: 1px solid var(--border); 
            padding: 12px 24px;
            border-radius: 8px; 
            font-size: 1rem; 
            cursor: pointer; 
            transition: background 0.2s;
        }
        
        /* Bottom Nav */
        .btm-nav {
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            height: calc(60px + env(safe-area-inset-bottom, 0px));
            background: var(--surface); 
            border-top: 1px solid var(--border);
            display: flex; 
            justify-content: space-around; 
            align-items: center;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding-bottom: env(safe-area-inset-bottom, 0px);
            z-index: 100;
        }
        
        .btm-btn { 
            background: none; 
            border: none; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            font-size: 10px; 
            color: var(--text-sec); 
            gap: 4px;
            padding: 8px; 
            border-radius: 8px; 
            transition: all 0.2s;
            flex: 1;
            max-width: 80px;
        }
        
        .btm-btn.active { 
            color: var(--primary); 
            background: rgba(79, 70, 229, 0.1); 
        }
        
        /* Loading spinner */
        .loading { 
            display: inline-block; 
            width: 20px; 
            height: 20px; 
            border: 2px solid var(--border); 
            border-top-color: var(--primary); 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        
        @keyframes spin { 
            to { 
                transform: rotate(360deg); 
            } 
        }
        
        /* Empty state */
        .empty-state { 
            text-align: center; 
            padding: 40px 20px; 
            color: var(--text-sec); 
        }
        
        .empty-state i { 
            margin-bottom: 16px; 
            opacity: 0.5; 
        }
        
        /* Toast notification */
        .toast {
            position: fixed; 
            bottom: 100px; 
            left: 50%; 
            transform: translateX(-50%);
            background: var(--surface); 
            padding: 12px 20px; 
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            z-index: 1000;
            animation: slideUp 0.3s ease;
            max-width: 90%;
            text-align: center;
        }
        
        @keyframes slideUp { 
            from { 
                bottom: 40px; 
                opacity: 0; 
            } 
            to { 
                bottom: 100px; 
                opacity: 1; 
            } 
        }
        
        /* Install Prompt */
        .install-prompt {
            position: fixed;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--surface);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            z-index: 999;
            width: 90%;
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideUp 0.3s ease;
        }
        
        .install-prompt button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid { 
                grid-template-columns: repeat(2, 1fr); 
            }
            .dash-grid { 
                grid-template-columns: repeat(2, 1fr); 
            }
        }
        
        @media (max-width: 640px) {
            .navbar { 
                padding: 0 12px; 
            }
            .search-box { 
                display: none; 
            }
        }
        
        @media (max-width: 480px) {
            .dash-grid { 
                grid-template-columns: 1fr; 
            }
        }
        
        /* PWA specific styles */
        @media (display-mode: standalone) {
            .navbar {
                height: calc(60px + env(safe-area-inset-top, 0px));
                padding-top: env(safe-area-inset-top, 0px);
            }
            
            .container {
                margin-top: calc(80px + env(safe-area-inset-top, 0px));
            }
        }
    </style>
</head>
<body>

<div id="app"></div>

<script>
    const app = {
        data: {
            tab: 'home',
            videos: [],
            videoInfoCache: {},
            modalOpen: false,
            addCat: 'physics',
            tempLinks: '',
            searchQuery: '',
            categories: ['physics', 'chemistry', 'biology', 'math', 'programming', 'history'],
            playlists: [],
            stats: {},
            toast: null,
            deferredPrompt: null,
            showInstallPrompt: false
        },

        init() {
            // Load saved data
            this.loadData();
            
            // Calculate initial stats
            this.updateStats();
            
            // Render UI
            this.render();
            
            // Register Service Worker
            this.registerServiceWorker();
            
            // Setup install prompt
            this.setupInstallPrompt();
            
            // Handle URL parameters
            this.handleUrlParams();
        },

        loadData() {
            const saved = localStorage.getItem('studyStreamDB');
            if (saved) {
                try { 
                    const data = JSON.parse(saved);
                    this.data.videos = data.videos || [];
                    this.data.categories = data.categories || this.data.categories;
                    this.data.playlists = data.playlists || [];
                } catch(e) {
                    console.error('Error loading data:', e);
                }
            }
        },

        save() {
            const data = {
                videos: this.data.videos,
                categories: this.data.categories,
                playlists: this.data.playlists,
                lastUpdated: Date.now()
            };
            localStorage.setItem('studyStreamDB', JSON.stringify(data));
            this.updateStats();
            this.render();
        },

        updateStats() {
            const total = this.data.videos.length;
            const completed = this.data.videos.filter(v => v.status === 'completed').length;
            const inProgress = this.data.videos.filter(v => v.status === 'in-progress').length;
            const totalMinutes = Math.round(this.data.videos
                .filter(v => v.status === 'completed')
                .reduce((sum, v) => sum + (v.duration || 0), 0) / 60);
            
            this.data.stats = { total, completed, inProgress, totalMinutes };
        },

        async registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('ServiceWorker registered:', registration);
                } catch (error) {
                    console.error('ServiceWorker registration failed:', error);
                }
            }
        },

        setupInstallPrompt() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                this.data.deferredPrompt = e;
                this.data.showInstallPrompt = true;
                this.render();
                
                // Auto-hide after 10 seconds
                setTimeout(() => {
                    this.data.showInstallPrompt = false;
                    this.render();
                }, 10000);
            });
            
            window.addEventListener('appinstalled', () => {
                this.data.deferredPrompt = null;
                this.data.showInstallPrompt = false;
                this.showToast('StudyStream installed successfully!');
            });
        },

        async promptInstall() {
            if (this.data.deferredPrompt) {
                this.data.deferredPrompt.prompt();
                const { outcome } = await this.data.deferredPrompt.userChoice;
                this.data.deferredPrompt = null;
                this.data.showInstallPrompt = false;
                this.render();
                
                if (outcome === 'accepted') {
                    this.showToast('Thank you for installing StudyStream!');
                }
            }
        },

        handleUrlParams() {
            const params = new URLSearchParams(window.location.search);
            if (params.has('add')) {
                this.toggleModal(true);
            }
            if (params.has('tab')) {
                const tab = params.get('tab');
                if (['home', ...this.data.categories].includes(tab)) {
                    this.setTab(tab);
                }
            }
        },

        showToast(message, duration = 3000) {
            if (this.data.toast) {
                clearTimeout(this.data.toast.timeout);
                this.data.toast.element.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = 'toast fade-in';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            const timeout = setTimeout(() => {
                toast.remove();
                this.data.toast = null;
            }, duration);
            
            this.data.toast = { element: toast, timeout };
        },

        async fetchVideoInfo(id) {
            if (this.data.videoInfoCache[id]) {
                return this.data.videoInfoCache[id];
            }
            
            const video = this.data.videos.find(v => v.id === id);
            if (video && video.title) {
                return {
                    title: video.title,
                    thumbnail: `https://img.youtube.com/vi/${id}/hqdefault.jpg`
                };
            }
            
            try {
                const response = await fetch(
                    `https://noembed.com/embed?url=https://www.youtube.com/watch?v=${id}`
                );
                const data = await response.json();
                
                const info = {
                    title: data.title || `Video ${id.substring(0,6)}...`,
                    thumbnail: `https://img.youtube.com/vi/${id}/hqdefault.jpg`
                };
                
                this.data.videoInfoCache[id] = info;
                
                if (video && data.title) {
                    video.title = data.title;
                }
                
                return info;
            } catch (error) {
                console.error('Failed to fetch video info:', error);
                return {
                    title: video && video.title ? video.title : `Video ${id.substring(0,6)}...`,
                    thumbnail: `https://img.youtube.com/vi/${id}/hqdefault.jpg`
                };
            }
        },

        setTab(t) { 
            this.data.tab = t; 
            this.data.searchQuery = '';
            this.render(); 
            window.scrollTo(0,0);
            // Update URL without reload
            const url = new URL(window.location);
            url.searchParams.set('tab', t);
            window.history.pushState({}, '', url);
        },
        
        toggleModal(v) { 
            this.data.modalOpen = v; 
            if (v) {
                this.data.tempLinks = '';
            }
            this.render(); 
        },
        
        setCat(c) { 
            this.data.addCat = c; 
            this.render(); 
        },

        async addVideos() {
            const input = document.getElementById('linkBox').value;
            const matches = input.matchAll(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))([\w-]{11})/g);
            const ids = [...matches].map(m => m[1]);
            const uniqueIds = [...new Set(ids)];

            if (uniqueIds.length > 0) {
                let added = 0;
                let skipped = 0;
                
                for (const id of uniqueIds) {
                    if (!this.data.videos.find(v => v.id === id)) {
                        const video = {
                            id, 
                            category: this.data.addCat, 
                            status: 'new',
                            progress: 0, 
                            duration: 0, 
                            added: Date.now(), 
                            lastWatched: 0,
                            notes: []
                        };
                        
                        this.data.videos.push(video);
                        added++;
                    } else {
                        skipped++;
                    }
                }
                
                this.data.modalOpen = false;
                this.save();
                
                let message = `Added ${added} new video${added !== 1 ? 's' : ''}`;
                if (skipped > 0) {
                    message += ` (${skipped} already exist)`;
                }
                this.showToast(message);
                
                this.render();
            } else {
                this.showToast("No valid YouTube links found!");
            }
        },

        deleteVideo(id) {
            if (confirm("Delete this video?")) {
                this.data.videos = this.data.videos.filter(v => v.id !== id);
                this.save();
                this.showToast("Video deleted");
            }
        },

        updateVideoStatus(id, status) {
            const video = this.data.videos.find(v => v.id === id);
            if (video) {
                video.status = status;
                if (status === 'completed') {
                    video.progress = video.duration || 0;
                }
                this.save();
                this.showToast(`Marked as ${status}`);
            }
        },

        playVideo(id) {
            const video = this.data.videos.find(v => v.id === id);
            if (!video) return;

            if (video.status === 'new') {
                video.status = 'in-progress';
                this.save();
            }

            const overlay = document.createElement('div');
            overlay.className = 'player-overlay fade-in';
            overlay.id = 'fs-container';
            overlay.innerHTML = `
                <div class="player-controls">
                    <button class="control-btn" onclick="app.toggleFullScreen()" title="Fullscreen">
                        <i data-lucide="maximize" width="20"></i>
                    </button>
                    <button class="control-btn" onclick="app.closePlayer()" title="Close">
                        <i data-lucide="x" width="20"></i>
                    </button>
                </div>
                <div class="video-wrapper">
                    <iframe 
                        id="yt-iframe"
                        src="https://www.youtube.com/embed/${id}?enablejsapi=1&autoplay=1&fs=1&start=${Math.floor(video.progress)}&rel=0" 
                        allow="autoplay; encrypted-media; fullscreen"
                        allowfullscreen
                        style="position:relative; z-index:1;"
                    ></iframe>
                </div>
            `;
            document.body.appendChild(overlay);
            lucide.createIcons();

            if (window.YT && window.YT.Player) {
                new YT.Player('yt-iframe', {
                    events: {
                        'onStateChange': (e) => {
                            if (e.data === 0) this.markComplete(id);
                            if (e.data === 2) this.updateProgress(id, e.target.getCurrentTime(), e.target.getDuration());
                        }
                    }
                });
            }
        },

        toggleFullScreen() {
            const elem = document.getElementById('fs-container');
            if (!document.fullscreenElement) {
                if (elem.requestFullscreen) { 
                    elem.requestFullscreen(); 
                } 
                else if (elem.webkitRequestFullscreen) { 
                    elem.webkitRequestFullscreen(); 
                } 
                else if (elem.msRequestFullscreen) { 
                    elem.msRequestFullscreen(); 
                }
            } else {
                if (document.exitFullscreen) { 
                    document.exitFullscreen(); 
                }
            }
        },

        closePlayer() {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
            const ov = document.querySelector('.player-overlay');
            if (ov) ov.remove();
            this.render();
        },

        updateProgress(id, time, duration) {
            const idx = this.data.videos.findIndex(v => v.id === id);
            if (idx > -1) {
                this.data.videos[idx].status = 'in-progress';
                this.data.videos[idx].progress = time;
                this.data.videos[idx].duration = duration;
                this.data.videos[idx].lastWatched = Date.now();
                this.save();
            }
        },

        markComplete(id) {
            const idx = this.data.videos.findIndex(v => v.id === id);
            if (idx > -1) {
                this.data.videos[idx].status = 'completed';
                this.data.videos[idx].progress = this.data.videos[idx].duration;
                this.save();
                this.closePlayer();
                this.showToast("Video marked as completed!");
            }
        },

        exportData() {
            const data = "data:text/json;charset=utf-8," + encodeURIComponent(
                JSON.stringify({
                    videos: this.data.videos,
                    categories: this.data.categories,
                    playlists: this.data.playlists,
                    exportedAt: new Date().toISOString()
                })
            );
            const a = document.createElement('a');
            a.href = data;
            a.download = `study_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            this.showToast("Backup exported successfully");
        },

        importData(el) {
            const file = el.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.videos) {
                        data.videos.forEach(newVideo => {
                            if (!this.data.videos.find(v => v.id === newVideo.id)) {
                                this.data.videos.push(newVideo);
                            }
                        });
                    }
                    
                    if (data.categories) {
                        data.categories.forEach(cat => {
                            if (!this.data.categories.includes(cat)) {
                                this.data.categories.push(cat);
                            }
                        });
                    }
                    
                    this.save();
                    this.showToast("Data imported successfully!");
                } catch (error) {
                    this.showToast("Error importing data");
                    console.error(error);
                }
                el.value = '';
            };
            reader.readAsText(file);
        },

        clearAllData() {
            if (confirm("Are you sure? This will delete ALL your data permanently.")) {
                if (confirm("Double check: This cannot be undone!")) {
                    localStorage.removeItem('studyStreamDB');
                    this.data.videos = [];
                    this.data.playlists = [];
                    this.updateStats();
                    this.render();
                    this.showToast("All data cleared");
                }
            }
        },

        async render() {
            const isHome = this.data.tab === 'home';
            let list = [...this.data.videos];
            
            if (!isHome) {
                list = list.filter(v => v.category === this.data.tab);
            } else {
                list = list.filter(v => v.status === 'in-progress');
            }
            
            if (this.data.searchQuery) {
                const query = this.data.searchQuery.toLowerCase();
                list = list.filter(v => {
                    const title = v.title || '';
                    return title.toLowerCase().includes(query) ||
                           v.id.toLowerCase().includes(query) ||
                           v.category.toLowerCase().includes(query) ||
                           v.status.toLowerCase().includes(query);
                });
            }
            
            if (isHome) {
                list.sort((a, b) => b.lastWatched - a.lastWatched);
            } else {
                list.sort((a, b) => {
                    if (a.status === 'completed' && b.status !== 'completed') return 1;
                    if (a.status !== 'completed' && b.status === 'completed') return -1;
                    if (a.status === 'in-progress' && b.status === 'in-progress') return b.lastWatched - a.lastWatched;
                    if (a.status === 'in-progress') return -1;
                    if (b.status === 'in-progress') return 1;
                    return b.added - a.added;
                });
            }
            
            let html = `
                <nav class="navbar">
                    <div class="logo">
                        <i data-lucide="book-open" width="20"></i> 
                        StudyStream
                    </div>
                    <div class="search-box">
                        <i data-lucide="search" width="16"></i>
                        <input type="text" id="searchInput" placeholder="Search videos..." 
                               value="${this.data.searchQuery}"
                               oninput="app.data.searchQuery = this.value; app.render();">
                    </div>
                    <button class="btn-add" onclick="app.toggleModal(true)">
                        <i data-lucide="plus" width="16"></i> 
                        Add Videos
                    </button>
                </nav>
                <div class="container fade-in">
            `;

            if (isHome) {
                html += `<h2 style="margin-bottom:5px">Dashboard</h2>
                        <p style="color:var(--text-sec); margin-bottom:20px; font-size:0.9rem;">
                            Track your learning progress
                        </p>
                        
                        <div class="stats-grid">
                            <div class="stat-card">
                                <i data-lucide="video" width="24"></i>
                                <h3>${this.data.stats.total}</h3>
                                <p>Total Videos</p>
                            </div>
                            <div class="stat-card">
                                <i data-lucide="check-circle" width="24"></i>
                                <h3>${this.data.stats.completed}</h3>
                                <p>Completed</p>
                            </div>
                            <div class="stat-card">
                                <i data-lucide="play-circle" width="24"></i>
                                <h3>${this.data.stats.inProgress}</h3>
                                <p>In Progress</p>
                            </div>
                            <div class="stat-card">
                                <i data-lucide="clock" width="24"></i>
                                <h3>${this.data.stats.totalMinutes}</h3>
                                <p>Minutes</p>
                            </div>
                        </div>
                        
                        <h3 style="margin:30px 0 15px 0;">Categories</h3>
                        <div class="dash-grid">
                            ${this.data.categories.map(c => {
                                const count = this.data.videos.filter(v => v.category === c && v.status !== 'completed').length;
                                const icon = {
                                    physics: 'atom',
                                    chemistry: 'flask-conical',
                                    biology: 'dna',
                                    math: 'calculator',
                                    programming: 'code',
                                    history: 'landmark'
                                }[c] || 'folder';
                                
                                return `<div class="dash-card" onclick="app.setTab('${c}')">
                                    <i data-lucide="${icon}" width="24" style="margin-bottom:8px; color:var(--primary)"></i>
                                    <h3 style="text-transform:capitalize">${c}</h3>
                                    <small>${count} left</small>
                                </div>`;
                            }).join('')}
                        </div>
                        
                        <h3 style="margin:30px 0 15px 0;">Continue Watching</h3>`;
                
                if (list.length === 0) {
                    html += `<div class="empty-state">
                                <i data-lucide="tv" width="48"></i>
                                <p>No videos in progress. Add some videos to get started!</p>
                            </div>`;
                }
            } else {
                const catVideos = this.data.videos.filter(v => v.category === this.data.tab);
                const completedCount = catVideos.filter(v => v.status === 'completed').length;
                const totalCount = catVideos.length;
                const progress = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
                
                html += `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                            <div>
                                <h2 style="text-transform:capitalize; margin-bottom:4px;">${this.data.tab}</h2>
                                <p style="color:var(--text-sec); font-size:0.9rem;">
                                    ${completedCount} of ${totalCount} completed (${progress}%)
                                </p>
                            </div>
                            <button class="btn-add" onclick="app.data.addCat='${this.data.tab}';app.toggleModal(true)">
                                <i data-lucide="plus" width="14"></i> Add
                            </button>
                        </div>`;
                
                if (list.length === 0) {
                    html += `<div class="empty-state">
                                <i data-lucide="video-off" width="48"></i>
                                <p>No videos in ${this.data.tab}. Add some videos!</p>
                            </div>`;
                }
            }

            if (list.length > 0) {
                const videoCards = await Promise.all(list.map(async (video) => {
                    const info = await this.fetchVideoInfo(video.id);
                    const pct = video.duration ? (video.progress / video.duration) * 100 : 0;
                    const statusClass = `status-${video.status}`;
                    
                    return `
                    <div class="video-card ${video.status === 'completed' ? 'completed' : ''}" 
                         onclick="app.playVideo('${video.id}')">
                        <div class="thumb-box">
                            <img class="thumb-img" src="${info.thumbnail}" loading="lazy" alt="${info.title}">
                            <div class="play-icon">
                                <i data-lucide="play" width="24" fill="currentColor"></i>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width:${pct}%"></div>
                        </div>
                        <div class="card-meta">
                            <div class="v-info">
                                <span class="v-cat">${video.category}</span>
                                <div style="display:flex; align-items:center; gap:4px; margin-bottom:4px;">
                                    <span class="status-badge ${statusClass}" style="text-transform:capitalize">
                                        ${video.status}
                                    </span>
                                    ${video.duration ? 
                                        `<span style="font-size:0.7rem; color:var(--text-sec);">
                                            ${Math.round(video.duration / 60)} min
                                        </span>` : ''
                                    }
                                </div>
                                <h3 title="${info.title}">
                                    ${info.title.length > 60 ? info.title.substring(0, 60) + '...' : info.title}
                                </h3>
                            </div>
                            <div style="display:flex; gap:8px;">
                                <button onclick="event.stopPropagation(); app.updateVideoStatus('${video.id}', 
                                        '${video.status === 'completed' ? 'in-progress' : 'completed'}')" 
                                        style="background:none; border:none; color:var(--text-sec); padding:4px;">
                                    <i data-lucide="${video.status === 'completed' ? 'rotate-ccw' : 'check'}" width="16"></i>
                                </button>
                                <button onclick="event.stopPropagation(); app.deleteVideo('${video.id}')" 
                                        style="background:none; border:none; color:#ef4444; padding:4px;">
                                    <i data-lucide="trash-2" width="16"></i>
                                </button>
                            </div>
                        </div>
                    </div>`;
                }));
                
                html += videoCards.join('');
            }

            if (isHome) {
                html += `<div style="margin-top:40px; padding-top:20px; border-top:1px solid var(--border);">
                            <div style="display:flex; flex-wrap:wrap; gap:12px; justify-content:center;">
                                <button class="btn-secondary" onclick="app.exportData()" 
                                        style="display:flex; align-items:center; gap:6px;">
                                    <i data-lucide="download" width="16"></i> Export Backup
                                </button>
                                <label class="btn-secondary" style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                                    <i data-lucide="upload" width="16"></i> Import Backup
                                    <input type="file" hidden accept=".json" onchange="app.importData(this)">
                                </label>
                                <button class="btn-secondary" onclick="app.clearAllData()" 
                                        style="display:flex; align-items:center; gap:6px; color:#ef4444;">
                                    <i data-lucide="trash" width="16"></i> Clear All
                                </button>
                            </div>
                            <p style="text-align:center; color:var(--text-sec); font-size:0.8rem; margin-top:16px;">
                                ${this.data.videos.length} videos â€¢ Last updated: ${new Date().toLocaleDateString()}
                            </p>
                        </div>`;
            }

            html += `</div>`;

            if (this.data.modalOpen) {
                html += `
                <div class="modal-wrap" onclick="if(event.target===this) app.toggleModal(false)">
                    <div class="modal-box fade-in">
                        <div class="modal-header">
                            <h3>Add Videos</h3>
                            <button onclick="app.toggleModal(false)" style="background:none; border:none; color:var(--text-sec);">
                                <i data-lucide="x" width="20"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p style="margin-bottom:15px; color:var(--text-sec); font-size:0.9rem;">
                                Paste YouTube links (one per line or separated by spaces)
                            </p>
                            
                            <div style="margin-bottom:15px;">
                                <label style="display:block; margin-bottom:8px; font-size:0.9rem;">Category</label>
                                <div class="category-chips">
                                    ${this.data.categories.map(c => `
                                        <div class="category-chip ${this.data.addCat === c ? 'selected' : ''}" 
                                             onclick="app.setCat('${c}')">
                                            ${c}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <textarea id="linkBox" class="input-area" placeholder="Example:&#10;https://youtu.be/dQw4w9WgXcQ&#10;https://www.youtube.com/watch?v=VIDEO_ID"
                                      autofocus>${this.data.tempLinks}</textarea>
                            
                            <div style="display:flex; gap:10px; margin-top:20px;">
                                <button class="btn-primary" onclick="app.addVideos()" style="flex:1;">
                                    <i data-lucide="plus" width="16"></i> Import Videos
                                </button>
                                <button class="btn-secondary" onclick="app.toggleModal(false)">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }

            // Install Prompt
            if (this.data.showInstallPrompt && !window.matchMedia('(display-mode: standalone)').matches) {
                html += `
                <div class="install-prompt fade-in">
                    <i data-lucide="download" width="24" style="color:var(--primary)"></i>
                    <div style="flex:1;">
                        <strong>Install StudyStream</strong>
                        <p style="font-size:0.8rem; color:var(--text-sec); margin-top:2px;">
                            Install for a better experience
                        </p>
                    </div>
                    <button onclick="app.promptInstall()">Install</button>
                    <button onclick="app.data.showInstallPrompt=false; app.render();" 
                            style="background:none; border:none; color:var(--text-sec); padding:4px;">
                        <i data-lucide="x" width="16"></i>
                    </button>
                </div>`;
            }

            // Bottom Navigation
            html += `
            <div class="btm-nav">
                ${['home', ...this.data.categories.slice(0, 4)].map(t => {
                    const icon = t === 'home' ? 'home' : 
                                 t === 'physics' ? 'atom' :
                                 t === 'chemistry' ? 'flask-conical' :
                                 t === 'biology' ? 'dna' :
                                 t === 'math' ? 'calculator' : 'folder';
                    
                    return `<button class="btm-btn ${this.data.tab === t ? 'active' : ''}" onclick="app.setTab('${t}')">
                        <i data-lucide="${icon}" width="20"></i>
                        <span style="text-transform:capitalize">${t}</span>
                    </button>`;
                }).join('')}
                <button class="btm-btn" onclick="app.toggleModal(true)" style="color:var(--primary);">
                    <i data-lucide="plus-circle" width="20"></i>
                    <span>Add</span>
                </button>
            </div>`;

            document.getElementById('app').innerHTML = html;
            lucide.createIcons();
            
            const searchInput = document.getElementById('searchInput');
            if (searchInput && this.data.searchQuery) {
                searchInput.focus();
                searchInput.setSelectionRange(this.data.searchQuery.length, this.data.searchQuery.length);
            }
            
            const linkBox = document.getElementById('linkBox');
            if (linkBox) {
                linkBox.focus();
            }
        }
    };

    window.onload = () => app.init();
    
    document.addEventListener('fullscreenchange', () => {
        if (!document.fullscreenElement) {
            const player = document.querySelector('.player-overlay');
            if (player) {
                // Optional: Add some handling when exiting fullscreen
            }
        }
    });
    
    // Handle back button for PWA
    window.addEventListener('popstate', () => {
        const params = new URLSearchParams(window.location.search);
        const tab = params.get('tab');
        if (tab && ['home', ...app.data.categories].includes(tab)) {
            app.setTab(tab);
        }
    });
</script>

</body>
  </html>
